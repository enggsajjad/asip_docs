\hypertarget{synthesis-and-hardware-implementation}{%
\chapter*{ModelSim Simulation}\label{synthesis-and-hardware-implementation}}

\rightline{\textbf{{1 Week}}}

\section*{Motivation and introduction}

In this session, we will compile a C-code application and simulate the
result in \emph{ModelSim and Dlxsim}. The applications can be assembled
or compiled using a compiler that is already generated by ASIPmeister in
the previous session. ModelSim simulates your code binaries using the
VHDL files generated from the ASIPmeister. While dlxsim only simulates
the instruction one by one and it does not care about the hardware
implementation of the instructions. For every part, that starts like
``a)'', ``b)'' \ldots{} you have to mail the answers and asked
files/tables to \textbf{sajjad.hussain@kit.edu} and use the topic
``asipXX-Session3'', with XX replaced by your group number.

\section*{Exercises}

\begin{enumerate}
\item \textbf{Preparing your project}
	
	\begin{enumerate}
	\item You can use the same project as in the last session, and just create a separate application subdirectory for the application. You can
		start a fresh project as in the Session 1, but this would be time
		consuming.
	\item For the C application, you have to create subdirectory in the
		``\emph{Application}'' directory (e.g. \emph{LoopExampleC}), and
		copy your application from
		``\emph{/home/ces-asip00/Sessions/Session3/6\_for.c}'' to here.
	\item Copy a ``\emph{Makefile}'' file from the ``\emph{TestPrint}''
		application subdirectory to each application subdirectory.
	\item Set proper parameters and settings in ``\emph{env\_settings}.
	\item For these exercises, we will be using pipeline forwarding (-pf1)
		option which is the default one.
	\item Make sure that you already have VHDL files and GNU tools in your
		project's meister directory.
	\end{enumerate}
\item \textbf{Compiling and Simulating the Application}
	\begin{enumerate}
	\item Go to your application subdirectory and type ``\emph{\textbf{make clean}}'' clean this directory it there are previously generated files.
	\item Compile the C application using ``\emph{\textbf{make sim}}''. A directory ``\emph{\textbf{BUILD\_SIM}}'' is created which contains different temporary files and a .dlxsim file to be simulated in dlxsim. In this directory, the files ``\emph{\textbf{TestData.IM}}'' and ``\emph{\textbf{TestData.DM}}''are the file used during the ModelSim simulation.
	\item In folder BUILD\_SIM, look at the ``\emph{6\_for.s}'' which is
	generated. Another file ``\emph{startup.s}'' is used along with the
	generated ``\emph{6\_for.s}'' to generate TestData.IM/DM files. Just
	understand and remember the structure of ``6\_for.s'' files if you
	have to write your own .s file, and how it is being executed along
	with ``\emph{startup.s}''.
	\item
	Simulate your application in dlxsim simulator using
	``\emph{\textbf{make dlxsim}}'', just to verify the functionality.
	\item
	In your project directory, go to the ``ModelSim'' directory and
	start the ModelSim using ``\emph{\textbf{vsim}}''
	\item
	If ModelSim asks for ``modelsim.ini'' choose the default one like
	``/Software/ModelSim/ModelSim\_6.6d/modeltech/modelsim.ini''
	\item
	Open File Menu \textgreater{} New \textgreater{} Project and enter a
	project name (e.g. browstd32) and change the project location to the
	ModelSim directory in your project directory. Confirm the dialog
	with the OK button.
	\item
	Choose ``Add Existing File'' button and browse to the
	meister/dlx\_basis.syn directory of your ASIP Meister project and
	select all the VHDL files for synthesis.
	\item
	Again, choose ``Add Existing File'' button and add the testbench
	files: tb\_browstd32.vhd, MemoryMapperTypes.vhd, MemoryMapper.vhd,
	and Helper.vhd from the ModelSim directory of your current project.
	\item
	{[}Optional{]} Configure the CPU Frequency for which you want to
	simulate your CPU, default is 50 MHz. Open the ModelSim testbench
	(``tb\_ browstd32.vhd''), search for CLK \_PERIOD, and change the
	value accordingly in ``ns''.
	\item
	Compile the project using Compile Menu \textgreater{} Compile Order
	\textgreater{} Auto Generate. Every file should have a green mark
	behind its name, showing that the compilation was successful.
	\item
	Run the simulation using Simulate Menu \textgreater{} Start
	Simulation. Open the work library, mark the entry
	``\emph{\textbf{cfg}}'' (that is the VHDL configuration for the
	testbench) in the list and press OK. That will start the simulation
	and you will get another two tabs attached to the Workspace window
	(sim / Files).
	\item
	{[}Optional{]} To load some predefined simulation settings choose
	Tools Menu \textgreater{} Tcl \textgreater{} Execute Macro and
	select the ``wave\_vhdl.do'' file in your ModelSim directory and
	press OK to load it. The wave-window is filled with certain signals
	that are useful to evaluate the simulation of the program execution
	on the processor.
	\item
	{[}Optional{]} If you want to dump VCD file of yor design for power
	estimation, you can enter following commands in ModelSim command
	prompt:
\begin{lstlisting}
	VSIM > vsim -t 1ns work.cfg
	VSIM > vcd file test.vcd
	VSIM > vcd add -r test/dut/*
\end{lstlisting}
	\item
	Press the button ``\emph{\textbf{Run all}}'' to run the simulation
	until it aborts. At the end of a simulation the message ``Failure:
	Simulation End'' is printed to show successful end of simulation. At
	the simulation end, the file ``\emph{\textbf{TestData.OUT}}'' is
	created in your ModelSim directory. It contains the content of the
	simulated memory after the CPU finished working. Therefore, if your
	algorithm is storing the result in the memory you can find the values
	here.
		\begin{enumerate}[label=(\alph*)]
		\color{red}\item\normalcolor
		How many cycles are required to execute this program DLXsim and
		ModelSim?
		\color{red}\item\normalcolor
		What are the contents of TestData.OUT? Are these correct? First value
		is the stack value; next 10 words belongs to array A, then 10 words
		belongs to array B, and C.
		\color{red}\item\normalcolor
		In the ModelSim waveform window, what is the starting address of PC
		after the reset? Moreover, after how many cycles your
		``\textbf{main}'' function is started? In the waveform, look at the PC
		and IR values.
		\end{enumerate}
	\item The default GCC compiler optimization is --O0. Try different
		optimization levels with dlxsim and ModelSim using e.g. ``\emph{make
			dlxsim GCC\_PARAM=-O1}'' or using ``\emph{make sim
			GCC\_PARAM=-O1}''.
	\item Repeat this benchmarking for all compiler optimization-levels like
		O0, O1, O2, O3 and O4 for both dlxsim and ModelSim.
		\begin{enumerate}[label=(\alph*)]
		\color{red}\item\normalcolor Does the application is executed successfully using different optimization levels? If yes, please fill the following benchmark table. These optimizations have distinct effects on the size of the code.
		\end{enumerate}
	\end{enumerate}
\end{enumerate}
\begin{table}[!htb]
\centering
	\begin{tabular}{|l|l|l|l|}
		\hline
		\multicolumn{1}{|c|}{\textbf{Optimization Level}} & \multicolumn{1}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}Executed?\\    \\ {[}Yes/No{]}\end{tabular}}} & \multicolumn{1}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}Cycle count\\    ModelSim\end{tabular}}} & \multicolumn{1}{c|}{\textbf{\begin{tabular}[c]{@{}c@{}}Cycle count\\    dlxsim\end{tabular}}} \\ \hline
		\textbf{-O0 (default)}                            &                                                                                                      &                                                                                                 &                                                                                               \\ \hline
		\textbf{-O1}                                      &                                                                                                      &                                                                                                 &                                                                                               \\ \hline
		\textbf{-O2}                                      &                                                                                                      &                                                                                                 &                                                                                               \\ \hline
		\textbf{-O3}                                      &                                                                                                      &                                                                                                 &                                                                                               \\ \hline
		\textbf{-O4}                                      &                                                                                                      &                                                                                                 &                                                                                               \\ \hline
	\end{tabular}
\end{table}

\textbf{Next Session:} Synthesis and Hardware Implementation

\textbf{Readings for the next session}: Laboratory Chapters 6
